# TCP
* 可靠性是硬指标：通过 ACK、重传、排序机制，不惜代价（头部开销、CPU 计算）保证数据准确。  
* 公平性与自适应性：拥塞控制算法体现了 TCP 的“公德心”。它假设网络是一个黑盒，
通过丢包作为拥塞信号，自动调整发送速率，实现了网络的自我平衡。  
* 带内信令：TCP 没有专门的控制通道，所有的控制信息（窗口
大小、ACK、标志位）都和数据包混在一起传输，效率极高。  
* 字节流而非报文流：TCP 不保留应用层消息的边界，这要求
应用层自己处理消息的粘包和拆包问题，但这给了传输层极大的灵活性。

## TCP 头部设计精要
TCP 头部通常为 20 字节（不含选项），设计极其紧凑：
* 源/目的端口：标识进程。
* 序列号/确认号：实现可靠传输。
* 数据偏移：指出 TCP 头部长度。
* 标志位： 
  * SYN：发起新连接。
  * ACK：确认序号有效。
  * FIN：关闭连接。
  * RST：重置连接（如连接出错）。
  * PSH：推送数据（尽快交给应用层）。
  * URG：紧急指针。
* 窗口大小：流量控制。
* 校验和：差错检测。


## 校验和
用于在一定程度上判断接受的数据是否有错误  

把数据分为每个16位，然后每个16位进行二进制求和，最后取反。期间的进位，回卷到
结果中，即 **+1**，不然如果进位丢失，导致接收到的求和数据和发送的求和数据
的后16位一致，校验和就失效了。

## 序列号 与 确认应答 (ACK)
解决丢包重传和乱序重排的问题

## 重传机制
### 超时重传
发送方设定一个定时器（RTO，Retransmission Timeout）。如果超时未收到 ACK，
则重发数据。  
难点：RTO 设定太难。太短会导致不必要的重传（网络拥塞），太长会导致响应慢。
TCP **动态计算** RTT（往返时间）来调整 RTO。
### 快速重传
如果发送方连续收到 3 个重复的 ACK，则认为该数据丢失，立即重传。

## 滑动窗口
设计思想：为了提高效率，不能采用“停止-等待”协议
（发一个等一个回）。TCP 允许发送方在未收到 ACK 的情况下连续发送多个数据包。  
机制：发送方维护一个发送窗口，接收方维护一个接收窗口。
窗口内的字节是可以被发送的。随着 ACK 的到来，窗口向右滑动。  
作用：实现了流水线机制，充分利用网络带宽。

## 流量控制
流量控制是为了控制发送方发送速率，保证接收方来得及接收。  
接收方发送的 ACK 中会包含自己的接收窗口大小，
发送方根据该值和当前网络拥塞程度来决定发送速率。

## 拥塞控制
拥塞控制是为了防止过多的数据注入到网络中，避免网络负载过重。  
慢启动，快重传，拥塞避免，快恢复。  
一开始发送方将拥塞窗口（congestion window，cwnd）
设置为一个最大报文段MSS的数值。 每收到一个 ACK，拥塞窗口加1。
当达到阈值后就进入拥塞避免阶段。
如果发生超时重传或者快速重传，则阈值设为当前拥塞窗口的一半。

## 三次握手
主要是为了防止已失效的连接请求报文段突然又传送到了服务端，
导致服务端错误开启连接，浪费资源。
1. 客户端发送 SYN 包（SYN=j）到服务器，并进入 SYN_SEND 状态，等待服务器确认；
2. 服务器收到 SYN 包，必须确认客户的 SYN（ACK=j+1），同时自己也发送
一个 SYN 包（SYN=k），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态；
3. 客户端收到服务器的 SYN+ACK 包，向服务器发送确认包 ACK（ACK=k+1）
，此包发送完毕。

## 四次挥手
由于 TCP 是全双工（双方可以同时发送）的，所以每个方向必须单独关闭。
TIME_WAIT 的作用：确保最后一个 ACK 能到达服务端；
等待网络中所有旧的报文段消失，防止干扰新连接。

1. 客户端发送 FIN 包，进入 FIN_WAIT_1 状态，等待服务器确认；
2. 服务器收到 FIN 包，发送 ACK 包，进入 CLOSE_WAIT 状态；
3. 服务器发送 FIN 包，进入 LAST_ACK 状态，等待客户端确认；
4. 客户端收到 FIN 包，发送 ACK 包，进入 TIME_WAIT 状态，等待 2MSL 后关闭连接。


# UDP
UDP 是面向报文的协议，不提供复杂的控制机制，利用 IP 提供面向无连接的通信服务。
UDP 是一种 **“牺牲可靠性换取速度”** 的协议。它不提供任何传输保障，但这正是它的价值所在。
在互联网的下半场，随着直播、云游戏、实时互动的兴起，UDP 的地位不仅没有下降
，反而因为 QUIC 等新技术的出现，变得越来越重要。
## UDP 报文头部结构
UDP 的头部非常短，只有 8 个字节（64 位），相比 TCP 的 20 字节起步，简直是轻量级。  
UDP 头部由四个字段组成：  
* 源端口：2 字节。发送方的端口号（可选，如果不需回信，可填 0）。
* 目的端口：2 字节。接收方的端口号（必须填，否则数据不知道给谁）。
* 长度：2 字节。UDP 首部 + 数据的总长度（最小 8 字节）。
* 校验和：2 字节。检测数据在传输中是否出错。
注意：在 IPv4 中，校验和是可选的（如果全填 0，表示不计算校验和）；但在 IPv6 中，它是强制的。


# HTTP
HTTP 是应用层协议，基于 TCP 协议。
## HTTP 报文结构
HTTP 报文由三部分组成：起始行、首部、主体。  
* 起始行：请求行（请求报文）或状态行（响应报文）。
* 首部：若干行名值对，每行以回车换行符结束。
* 主体：可选，用于传输数据。
* HTTP 报文是纯文本，易于阅读。
* HTTP 报文是二进制协议，但可以文本形式展示。
* HTTP 报文是自描述的，每个字段都有意义。
* HTTP 报文是面向连接的，但可以无状态。
* HTTP 报文是面向文本的，但可以传输二进制数据。
* HTTP 报文是面向请求-响应的，但可以双向通信。
* HTTP 报文是面向无连接的，但可以保持连接。
* HTTP 报文是面向无状态的，但可以保持状态。
